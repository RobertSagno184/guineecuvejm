<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<div class="reports">
  <div class="page-header">
    <div>
      <h1>Rapports et statistiques</h1>
      <p class="subtitle">Analysez vos performances et générez des rapports détaillés</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="exportExcel()">
        <i class="fas fa-file-excel"></i> Exporter Excel
      </button>
      <button class="btn-secondary" (click)="exportPDF()">
        <i class="fas fa-file-pdf"></i> Exporter PDF
      </button>
    </div>
  </div>

  <!-- Filtres de période -->
  <div class="filters-section">
    <div class="period-filters">
      <div class="filter-group">
        <label>Période</label>
        <select 
          [value]="periodPreset()" 
          (change)="onPeriodPresetChange($any($event.target).value)"
          class="filter-select"
        >
          <option value="today">Aujourd'hui</option>
          <option value="week">Cette semaine</option>
          <option value="month">Ce mois</option>
          <option value="quarter">Ce trimestre</option>
          <option value="year">Cette année</option>
          <option value="custom">Personnalisé</option>
        </select>
      </div>

      <div class="filter-group" *ngIf="periodPreset() === 'custom'">
        <label>Date début</label>
        <input
          type="date"
          [value]="dateFrom()"
          (change)="dateFrom.set($any($event.target).value); onDateChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group" *ngIf="periodPreset() === 'custom'">
        <label>Date fin</label>
        <input
          type="date"
          [value]="dateTo()"
          (change)="dateTo.set($any($event.target).value); onDateChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label>
          <input
            type="checkbox"
            [checked]="comparePeriod()"
            (change)="comparePeriod.set($any($event.target).checked)"
          />
          Comparer avec une autre période
        </label>
      </div>

      <div class="filter-group" *ngIf="comparePeriod()">
        <label>Période de comparaison - Début</label>
        <input
          type="date"
          [value]="compareDateFrom()"
          (change)="compareDateFrom.set($any($event.target).value)"
          class="filter-input"
        />
      </div>

      <div class="filter-group" *ngIf="comparePeriod()">
        <label>Période de comparaison - Fin</label>
        <input
          type="date"
          [value]="compareDateTo()"
          (change)="compareDateTo.set($any($event.target).value)"
          class="filter-input"
        />
      </div>
    </div>
  </div>

  <!-- Résumé exécutif (KPIs) -->
  <div class="kpi-section" *ngIf="!isLoading()">
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon" style="background: rgba(255, 152, 0, 0.1);">
          <i class="fas fa-dollar-sign" style="color: #ff9800;"></i>
        </div>
        <div class="kpi-content">
          <h3>Chiffre d'affaires</h3>
          <p class="kpi-value">{{ formatCurrency(salesStats().totalRevenue) }}</p>
          <p class="kpi-growth" *ngIf="growthRate() !== null" [class.positive]="growthRate()! >= 0" [class.negative]="growthRate()! < 0">
            <i class="fas" [class.fa-arrow-up]="growthRate()! >= 0" [class.fa-arrow-down]="growthRate()! < 0"></i>
            {{ formatPercentage(growthRate()!) }}
          </p>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon" style="background: rgba(30, 136, 229, 0.1);">
          <i class="fas fa-shopping-cart" style="color: #1e88e5;"></i>
        </div>
        <div class="kpi-content">
          <h3>Nombre de commandes</h3>
          <p class="kpi-value">{{ salesStats().orderCount }}</p>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon" style="background: rgba(76, 175, 80, 0.1);">
          <i class="fas fa-calculator" style="color: #4caf50;"></i>
        </div>
        <div class="kpi-content">
          <h3>Panier moyen</h3>
          <p class="kpi-value">{{ formatCurrency(salesStats().averageOrderValue) }}</p>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon" style="background: rgba(255, 193, 7, 0.1);">
          <i class="fas fa-clock" style="color: #ffc107;"></i>
        </div>
        <div class="kpi-content">
          <h3>Commandes en attente</h3>
          <p class="kpi-value">{{ salesStats().pendingOrders }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Onglets -->
  <div class="tabs-section" *ngIf="!isLoading()">
    <div class="tabs-header">
      <button
        class="tab-button"
        [class.active]="activeTab() === 'overview'"
        (click)="setActiveTab('overview')"
      >
        <i class="fas fa-chart-line"></i> Vue d'ensemble
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'sales'"
        (click)="setActiveTab('sales')"
      >
        <i class="fas fa-shopping-bag"></i> Ventes
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'products'"
        (click)="setActiveTab('products')"
      >
        <i class="fas fa-box"></i> Produits
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'customers'"
        (click)="setActiveTab('customers')"
      >
        <i class="fas fa-users"></i> Clients
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'inventory'"
        (click)="setActiveTab('inventory')"
      >
        <i class="fas fa-warehouse"></i> Inventaire
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'financial'"
        (click)="setActiveTab('financial')"
      >
        <i class="fas fa-chart-pie"></i> Financier
      </button>
    </div>

    <!-- Contenu des onglets -->
    <div class="tabs-content">
      <!-- Vue d'ensemble -->
      <div class="tab-panel" *ngIf="activeTab() === 'overview'">
        <div class="charts-grid">
          <div class="chart-card">
            <canvas #salesChart></canvas>
          </div>
          <div class="chart-card">
            <canvas #categoryChart></canvas>
          </div>
          <div class="chart-card">
            <canvas #statusChart></canvas>
          </div>
        </div>
      </div>

      <!-- Ventes -->
      <div class="tab-panel" *ngIf="activeTab() === 'sales'">
        <div class="report-section">
          <h2>Rapport des ventes</h2>
          <div class="stats-summary">
            <div class="stat-item">
              <span class="stat-label">Chiffre d'affaires total</span>
              <span class="stat-value">{{ formatCurrency(salesStats().totalRevenue) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Nombre de commandes</span>
              <span class="stat-value">{{ salesStats().orderCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Panier moyen</span>
              <span class="stat-value">{{ formatCurrency(salesStats().averageOrderValue) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Commandes livrées</span>
              <span class="stat-value">{{ salesStats().completedOrders }}</span>
            </div>
          </div>
          <div class="chart-card full-width">
            <canvas #salesChart></canvas>
          </div>
        </div>
      </div>

      <!-- Produits -->
      <div class="tab-panel" *ngIf="activeTab() === 'products'">
        <div class="report-section">
          <h2>Rapport des produits</h2>
          <div class="chart-card">
            <canvas #productsChart></canvas>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Produit</th>
                  <th>Quantité vendue</th>
                  <th>Chiffre d'affaires</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of topProducts(); let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ item.product.name }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ formatCurrency(item.revenue) }}</td>
                </tr>
                <tr *ngIf="topProducts().length === 0">
                  <td colspan="4" class="no-data">Aucune donnée disponible</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Clients -->
      <div class="tab-panel" *ngIf="activeTab() === 'customers'">
        <div class="report-section">
          <h2>Rapport des clients</h2>
          <div class="chart-card">
            <canvas #customersChart></canvas>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Client</th>
                  <th>Nombre de commandes</th>
                  <th>Total dépensé</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of topCustomers(); let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ item.customer.companyName || item.customer.contactPerson }}</td>
                  <td>{{ item.orderCount }}</td>
                  <td>{{ formatCurrency(item.totalSpent) }}</td>
                </tr>
                <tr *ngIf="topCustomers().length === 0">
                  <td colspan="4" class="no-data">Aucune donnée disponible</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Inventaire -->
      <div class="tab-panel" *ngIf="activeTab() === 'inventory'">
        <div class="report-section">
          <h2>Rapport d'inventaire</h2>
          <div class="stats-summary">
            <div class="stat-item">
              <span class="stat-label">Réceptions</span>
              <span class="stat-value">{{ inventoryStats().receptions }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ajustements</span>
              <span class="stat-value">{{ inventoryStats().adjustments }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Valeur totale de l'inventaire</span>
              <span class="stat-value">{{ formatCurrency(inventoryStats().totalInventoryValue) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Produits en stock faible</span>
              <span class="stat-value">{{ inventoryStats().lowStockCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Produits en rupture</span>
              <span class="stat-value">{{ inventoryStats().outOfStockCount }}</span>
            </div>
          </div>
          <div class="chart-card full-width">
            <canvas #stockChart></canvas>
          </div>
        </div>
      </div>

      <!-- Financier -->
      <div class="tab-panel" *ngIf="activeTab() === 'financial'">
        <div class="report-section">
          <h2>Rapport financier</h2>
          <div class="financial-summary">
            <div class="financial-card">
              <h3>Revenus</h3>
              <p class="financial-value positive">{{ formatCurrency(salesStats().totalRevenue) }}</p>
            </div>
            <div class="financial-card">
              <h3>Taxes (estimées à 18%)</h3>
              <p class="financial-value">{{ formatCurrency(salesStats().totalRevenue * 0.18) }}</p>
            </div>
            <div class="financial-card">
              <h3>Revenus nets (estimés)</h3>
              <p class="financial-value positive">{{ formatCurrency(salesStats().totalRevenue * 0.82) }}</p>
            </div>
          </div>
          <div class="chart-card full-width">
            <canvas #categoryChart></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loading>
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i> Chargement des données...
    </div>
  </ng-template>
</div>
